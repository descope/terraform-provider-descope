name: Build and Setup

description: Build and Setup

inputs:
  go_version:
    description: 'Version of Go to use for this build'
    required: true

runs:
  using: composite
  steps:
    - name: Setup Repo
      uses: ./.github/actions/ci/setup
      with:
        go_version: ${{ inputs.go_version }}

    - name: Check Go Files
      shell: bash
      run: |
        echo "Running go mod tidy"
        set +e
        go mod tidy
        if [ "$?" != "0" ]; then
          echo "Unexpected error running 'go mod tidy'"
          exit 1
        fi
        echo "Checking for diffs"
        git diff --exit-code
        if [ "$?" != "0" ]; then
          echo "Unexpected diff after running 'go mod tidy'"
          exit 1
        fi

    - name: Build Code
      shell: bash
      run: go build -v ./...

    - name: Run Tests
      shell: bash
      run: go test -v ./...
